name: Continuous Deployment

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  deploy:
    name: Deploy Changed Pairs
    runs-on: ubuntu-latest
    env:
      TERRAFORM_STATUS: apply
      TF_VAR_CSCO_NXOS_TF_USERNAME: ${{ secrets.TF_VAR_CSCO_NXOS_TF_USERNAME }}
      TF_VAR_CSCO_NXOS_TF_PASSWORD: ${{ secrets.TF_VAR_CSCO_NXOS_TF_PASSWORD }}

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v1

      - name: Find changed pair directories
        id: find_dirs
        run: |
          echo "Changed directories:"
          CHANGED_DIRS=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '^SITE-' | grep 'PAIR-' | cut -d/ -f1,2 | sort -u)
          echo "$CHANGED_DIRS" > changed_dirs.txt
          echo "pairs=$(echo $CHANGED_DIRS | tr '\n' ' ')" >> $GITHUB_OUTPUT

      - name: Run Terraform in changed directories
        if: steps.find_dirs.outputs.pairs != ''
        shell: bash
        run: |
          CHANGED_DIRS=$(cat changed_dirs.txt)
          GITHUB_EVENT_NAME="${{ github.event_name }}"
          GITHUB_REF="${{ github.ref }}"

          for dir in $CHANGED_DIRS; do
            echo "ðŸ”„ Processing directory: $dir"
            cd $dir

            terraform init
            terraform fmt
            terraform validate

            if [ "$GITHUB_EVENT_NAME" = "pull_request" ]; then
              echo "ðŸ“„ Running terraform plan..."
              terraform plan -no-color -out=tfplan.out || exit 1
              terraform show -no-color tfplan.out
            fi

            if [ "$GITHUB_REF" = "refs/heads/main" ] && [ "${TERRAFORM_STATUS}" = "apply" ]; then
              echo "ðŸš€ Applying changes..."
              terraform apply --auto-approve || exit 1
            fi

            if [ "$GITHUB_REF" = "refs/heads/main" ] && [ "${TERRAFORM_STATUS}" = "destroy" ]; then
              echo "ðŸ§¨ Destroying resources..."
              terraform destroy --auto-approve || exit 1
            fi

            cd - || exit 1
          done